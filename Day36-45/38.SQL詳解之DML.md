## SQL詳解之DML

我們接着上一課中創建的學校選課系統數據庫，為大家講解 DML 的使用。DML 可以幫助將數據插入到二維表（`insert`操作）、從二維表删除數據（`delete`操作）以及更新二維表的數據（`update`操作）。在執行 DML 之前，我們先通過下面的`use`命令切換到`school`數據庫。

```SQL
use `school`;
```

### insert操作

顧名思義，`insert`是用來插入行到二維表中的，插入的方式包括：插入完整的行、插入行的一部分、插入多行、插入查詢的結果。我們通過如下所示的 SQL 向學院表中添加一個學院。

```SQL
insert into `tb_college` values (default, '計算機學院', '學習計算機科學與技術的地方');
```

其中，由於學院表的主鍵是一個自增字段，因此上面的 SQL 中用`default`表示該列使用默認值，我們也可以使用下面的方式完成同樣的操作。

```SQL
insert into `tb_college` (`col_name`, `col_intro`) values ('計算機學院', '學習計算機科學與技術的地方');
```

我們推薦大家使用下面這種做法，指定為哪些字段賦值，這樣做可以不按照建表時設定的字段順序賦值，可以按照`values`前面的元組中給定的字段順序為字段賦值，但是需要注意，除了允許為`null`和有默認值的字段外，其他的字段都必須要一一列出並在`values`後面的元組中為其賦值。如果希望一次性插入多條記錄，我們可以在`values`後面跟上多個元組來實現批量插入，代碼如下所示。

```SQL
insert into `tb_college` 
    (`col_name`, `col_intro`) 
values 
    ('外國語學院', '學習歪果仁的語言的學院'),
    ('經濟管理學院', '經世濟民，治理國家；管理科學，興國之道'),
    ('體育學院', '發展體育運動，增強人民體質');
```

在插入數據時，要注意主鍵是不能重複的，如果插入的數據與表中已有記錄主鍵相同，那麼`insert`操作將會產生 Duplicated Entry 的報錯信息。再次提醒大家，如果`insert`操作省略了某些列，那麼這些列要麼有默認值，要麼允許為`null`，否則也將產生錯誤。在業務系統中，為了讓`insert`操作不影響其他操作（主要是後面要講的`select`操作）的性能，可以在`insert`和`into`之間加一個`low_priority`來降低`insert`操作的優先級，這個做法也適用於下面要講的`delete`和`update`操作。

假如有一張名為`tb_temp`的表中有`a`和`b`兩個列，分別保存了學院的名稱和學院的介紹，我們也可以通過查詢操作獲得`tb_temp`表的數據並插入到學院表中，如下所示，其中的`select`就是我們之前提到的 DQL，在下一課中會詳細講解。

```SQL
insert into `tb_college`
    (`col_name`, `col_intro`)
select `a`, `b` from `tb_temp`;
```

### delete 操作

如果需要從表中删除數據，可以使用`delete`操作，它可以幫助我們删除指定行或所有行，例如我們要删除編號為`1`的學院，就可以使用如下所示的 SQL。

```SQL
delete from `tb_college` where col_id=1;
```

注意，上面的`delete`操作中的`where`子句是用來指定條件的，只有滿足條件的行會被删除。如果我們不小心寫出了下面的 SQL，就會删除學院表中所有的記錄，這是相當危險的，在實際工作中通常也不會這麼做。

```SQL
delete from `tb_college`;
```

需要說明的是，即便删除了所有的數據，`delete`操作不會删除表本身，也不會讓 AUTO_INCREMENT 字段的值回到初始值。如果需要删除所有的數據而且讓 AUTO_INCREMENT 字段回到初始值，可以使用`truncate table`執行截斷表操作，`truncate`的本質是删除原來的表並重新創建一個表，它的速度其實更快，因為不需要逐行删除數據。但是請大家記住一點，用`truncate table`删除數據是非常危險的，因為它會删除所有的數據，而且由於原來的表已經被删除了，要想恢複誤删除的數據也會變得極為困難。

### update 操作

如果要修改表中的數據，可以使用`update`操作，它可以用來删除指定的行或所有的行。例如，我們將學生表中的“楊過”修改為“楊逍”，這里我們假設“楊過”的學號為`1001`，代碼如下所示。

```SQL
update `tb_student` set `stu_name`='楊逍' where `stu_id`=1001;
```

注意上面 SQL 中的`where`子句，我們使用學號作為條件篩選出對應的學生，然後通過前面的賦值操作將其姓名修改為“楊逍”。這里為什麼不直接使用姓名作為篩選條件，那是因為學生表中可能有多個名為“楊過”的學生，如果使用 stu_name 作為篩選條件，那麼我們的`update`操作有可能會一次更新多條數據，這顯然不是我們想要看到的。還有一個需要注意的地方是`update`操作中的`set`關鍵字，因為 SQL 中的`=`並不表示賦值，而是判斷相等的運算符，只有出現在`set` 關鍵字後面的`=`，才具備賦值的能力。

如果要同時修改學生的姓名和生日，我們可以對上面的`update`語句稍作修改，如下所示。

```SQL
update `tb_student` set `stu_name`='楊逍', `stu_birth`='1975-12-29' where `stu_id`=1001;
```

`update`語句中也可以使用查詢的方式獲得數據並以此來更新指定的表數據，有興趣的讀者可以自行研究。在書寫`update`語句時，通常都會有`where`子句，因為實際工作中幾乎不太會用到更新全表的操作，這一點大家一定要注意。

### 完整的數據

下面我們給出完整的向 school 數據庫的五張表中插入數據的 SQL。

```SQL
use `school`;

-- 插入學院數據
insert into `tb_college` 
    (`col_name`, `col_intro`) 
values 
    ('計算機學院', '計算機學院1958年設立計算機專業，1981年建立計算機科學系，1998年設立計算機學院，2005年5月，為了進一步整合教學和科研資源，學校決定，計算機學院和軟件學院行政班子合並統一運作、實行教學和學生管理獨立運行的模式。 學院下設三個系：計算機科學與技術系、物聯網工程系、計算金融系；兩個研究所：圖象圖形研究所、網絡空間安全研究院（2015年成立）；三個教學實驗中心：計算機基礎教學實驗中心、IBM技術中心和計算機專業實驗中心。'),
    ('外國語學院', '外國語學院設有7個教學單位，6個文理兼收的本科專業；擁有1個一級學科博士授予點，3個二級學科博士授予點，5個一級學科碩士學位授權點，5個二級學科碩士學位授權點，5個碩士專業授權領域，同時還有2個碩士專業學位（MTI）專業；有教職員工210餘人，其中教授、副教授80餘人，教師中獲得中國國內外名校博士學位和正在職攻讀博士學位的教師比例佔專任教師的60%以上。'),
    ('經濟管理學院', '經濟學院前身是創辦於1905年的經濟科；已故經濟學家彭迪先、張與九、蔣學模、胡寄窗、陶大鏞、胡代光，以及當代學者劉詩白等曾先後在此任教或學習。');

-- 插入學生數據
insert into `tb_student` 
    (`stu_id`, `stu_name`, `stu_sex`, `stu_birth`, `stu_addr`, `col_id`) 
values
    (1001, '楊過', 1, '1990-3-4', '湖南長沙', 1),
    (1002, '任我行', 1, '1992-2-2', '湖南長沙', 1),
    (1033, '王語嫣', 0, '1989-12-3', '四川成都', 1),
    (1572, '岳不群', 1, '1993-7-19', '陝西咸陽', 1),
    (1378, '紀嫣然', 0, '1995-8-12', '四川綿陽', 1),
    (1954, '林平之', 1, '1994-9-20', '福建莆田', 1),
    (2035, '東方不敗', 1, '1988-6-30', null, 2),
    (3011, '林震南', 1, '1985-12-12', '福建莆田', 3),
    (3755, '項少龍', 1, '1993-1-25', '四川成都', 3),
    (3923, '楊不悔', 0, '1985-4-17', '四川成都', 3);

-- 插入老師數據
insert into `tb_teacher` 
    (`tea_id`, `tea_name`, `tea_title`, `col_id`) 
values 
    (1122, '張三豐', '教授', 1),
    (1133, '宋遠橋', '副教授', 1),
    (1144, '楊逍', '副教授', 1),
    (2255, '範遙', '副教授', 2),
    (3366, '韋一笑', default, 3);

-- 插入課程數據
insert into `tb_course` 
    (`cou_id`, `cou_name`, `cou_credit`, `tea_id`) 
values 
    (1111, 'Python程序設計', 3, 1122),
    (2222, 'Web前端開發', 2, 1122),
    (3333, '操作系統', 4, 1122),
    (4444, '計算機網絡', 2, 1133),
    (5555, '編譯原理', 4, 1144),
    (6666, '算法和數據結構', 3, 1144),
    (7777, '經貿法語', 3, 2255),
    (8888, '成本會計', 2, 3366),
    (9999, '審計學', 3, 3366);

-- 插入選課數據
insert into `tb_record` 
    (`stu_id`, `cou_id`, `sel_date`, `score`) 
values 
    (1001, 1111, '2017-09-01', 95),
    (1001, 2222, '2017-09-01', 87.5),
    (1001, 3333, '2017-09-01', 100),
    (1001, 4444, '2018-09-03', null),
    (1001, 6666, '2017-09-02', 100),
    (1002, 1111, '2017-09-03', 65),
    (1002, 5555, '2017-09-01', 42),
    (1033, 1111, '2017-09-03', 92.5),
    (1033, 4444, '2017-09-01', 78),
    (1033, 5555, '2017-09-01', 82.5),
    (1572, 1111, '2017-09-02', 78),
    (1378, 1111, '2017-09-05', 82),
    (1378, 7777, '2017-09-02', 65.5),
    (2035, 7777, '2018-09-03', 88),
    (2035, 9999, '2019-09-02', null),
    (3755, 1111, '2019-09-02', null),
    (3755, 8888, '2019-09-02', null),
    (3755, 9999, '2017-09-01', 92);
```

> **注意**：上面的`insert`語句使用了批處理的方式來插入數據，這種做法插入數據的效率比較高。



